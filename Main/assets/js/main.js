var newMenu = [
    {
        "sys": { "id": "1" },
        "fields": {
            "title": "Chicken Sandwich",
            "category": "Sandwich",
            "price": "45",
            "caleories": "220 - 280 Kcal",
            "image": { "fields": {"file": { "url": "https://vaya.in/recipes/wp-content/uploads/2018/06/Grilled-Chicken-Sandwich.jpg" } } }
        }
    },
    {
        "sys": { "id": "2" },
        "fields": {
            "title": "Veg Sandwich",
            "category": "Sandwich",
            "price": "45",
            "caleories": "250 - 300 Kcal",
            "image": { "fields": {"file": { "url": "https://subwayaruba.com/wp-content/uploads/2019/05/sub6-veggie-delite.jpg" } } }
        }
    },
    {
        "sys": { "id": "3" },
        "fields": {
            "title": "Veg Cutlet ",
            "category": "Cutlet",
            "price": "60",
            "caleories": "320 - 400 Kcal",
            "image": { "fields": {"file": { "url": "https://www.cookwithmanali.com/wp-content/uploads/2021/04/Veg-Cutlet.jpg" } } }
        }
    },
    {
        "sys": { "id": "4" },
        "fields": {
            "title": "Chicken Cutlet",
            "category": "Cutlet",
            "price": "45",
            "caleories": "250 - 300 Kcal",
            "image": { "fields": {"file": { "url": "https://cdn3.foodviva.com/static-content/food-images/snacks-recipes/vegetable-cutlet-recipe/vegetable-cutlet-recipe.jpg" } } }
        }
    },
    {
        "sys": { "id": "5" },
        "fields": {
            "title": "Meat Roll",
            "category": "Roll",
            "price": "45",
            "caleories": "230 - 285 Kcal",
            "image": { "fields": {"file": { "url": "https://1.bp.blogspot.com/-7dPIbobpVxw/YQFZM1ccJwI/AAAAAAAATlI/oNIXqCuxChMmyfgYnB84Nqlg7JNQ6BDOwCLcBGAsYHQ/s800/IMG_2214.JPG" } } }
        }
    },
    {
        "sys": { "id": "6" },
        "fields": {
            "title": "Samosa",
            "category": "Samosa",
            "price": "25",
            "caleories": "150 - 280 Kcal",
            "image": { "fields": {"file": { "url": "https://dwellbymichelle.com/wp-content/uploads/2021/03/DWELL-Samosa-Recipe.jpeg" } } }
        }
    },
    {
        "sys": { "id": "7" },
        "fields": {
            "title": "Banana fry ",
            "category": "Banana fry",
            "price": "30",
            "caleories": "165 - 225 Kcal",
            "image": { "fields": {"file": { "url": "https://static.toiimg.com/thumb/93738582.cms?width=1200&height=900" } } }
        }
    },
    {
        "sys": { "id": "8" },
        "fields": {
            "title": "Chicken Puffs",
            "category": "Puffs",
            "price": "30",
            "caleories": "170 - 220 Kcal",
            "image": { "fields": {"file": { "url": "https://littlespicejar.com/wp-content/uploads/2014/02/Chicken-Puff-Pastry-Chicken-Patties-18-540x720.jpg" } } }
        }
    },
    {
        "sys": { "id": "9" },
        "fields": {
            "title": "Egg Puffs",
            "category": "Puffs",
            "price": "40",
            "caleories": "190 - 230 Kcal",
            "image": { "fields": {"file": { "url": "https://thegoldenlamb.com/wp-content/uploads/2021/09/egg-puff-recipe-indian-main.jpg" } } }
        }
    },
    {
        "sys": { "id": "10" },
        "fields": {
            "title": "Bread fry",
            "category": "Bread",
            "price": "45",
            "caleories": "175 - 235 Kcal",
            "image": { "fields": {"file": { "url": "https://villagecookingkerala.com/wp-content/uploads/2021/01/jgjjjgjgj-678x381.jpg" } } }
        }
    },
    {
        "sys": { "id": "11" },
        "fields": {
            "title": "Smoodh",
            "category": "Drinks",
            "price": "35",
            "caleories": "120 - 185 Kcal",
            "image": { "fields": {"file": { "url": "https://gumlet.assettype.com/foodtechbiz%2F2021-06%2F14ee0fde-adbc-4d9e-9125-60fc593b0de0%2F1624261283053.jpg?rect=0%2C7%2C1080%2C608&w=1200&auto=format%2Ccompress&ogImage=true&enlarge=true" } } }
        }
    },
    {
        "sys": { "id": "12" },
        "fields": {
            "title": "Maa Juice",
            "category": "Drinks",
            "price": "45",
            "caleories": "135 - 210 Kcal",
            "image": { "fields": {"file": { "url": "https://www.luluhypermarket.in/medias/29216-01.jpg-1200Wx1200H?context=bWFzdGVyfGltYWdlc3wyMTU0MTJ8aW1hZ2UvanBlZ3xhRFZrTDJnNVppODRPRGN5TlRRNE9ESTNNVFkyTHpJNU1qRTJMVEF4TG1wd1oxOHhNakF3VjNneE1qQXdTQXwwYmYyZGQ1YmZjYzAxMjJmY2I1MzM0NzEwMjZmMzI1OThkNDVhYjgzMTQ1ZjMxZWQzMTZhZGFmMzNkOWFjNmFj" } } }
        }
    },
    {
        "sys": { "id": "13" },
        "fields": {
            "title": "Coca Cola",
            "category": "Drinks",
            "price": "40",
            "caleories": "140 - 156 Kcal",
            "image": { "fields": {"file": { "url": "https://i.guim.co.uk/img/media/d13a335be378fd1d5360d34a88faefe2b6e38ca9/0_156_3500_2100/master/3500.jpg?width=700&quality=85&auto=format&fit=max&s=092c5fc37ff9a1f56faae91550b1d035" } } }
        }
    },
    {
        "sys": { "id": "14" },
        "fields": {
            "title": "Appy Fizz",
            "category": "Drinks",
            "price": "80",
            "caleories": "241 - 321 Kcal",
            "image": { "fields": {"file": { "url": "https://cdn.shopify.com/s/files/1/0101/2364/0896/products/IMG_9013_78bbfa5f-f257-402d-aab7-767b09c9d4dc_600x600_crop_center.jpg?v=1674192376" } } }
        }
    },
    {
        "sys": { "id": "15" },
        "fields": {
            "title": "Sprite",
            "category": "Drinks",
            "price": "80",
            "caleories": "265 - 321 Kcal",
            "image": { "fields": {"file": { "url": "https://ucarecdn.com/65a5c249-0a78-43dd-b035-238311381538/-/crop/1581x888/0,30/-/preview/" } } }
        }
    },
    {
        "sys": { "id": "16" },
        "fields": {
            "title": "Monster",
            "category": "Drinks",
            "price": "35",
            "caleories": "155 - 210 Kcal",
            "image": { "fields": {"file": { "url": "https://www.cantechonline.com/wp-content/uploads/Monster-Energy-drink-shutterstock_1145314877.jpg" } } }
        }
    },
    {
        "sys": { "id": "17" },
        "fields": {
            "title": "Predator",
            "category": "Drinks",
            "price": "35",
            "caleories": "230 - 280 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/hot-coffee.jpg" } } }
        }
    },
    {
        "sys": { "id": "18" },
        "fields": {
            "title": "Cavins",
            "category": "Drinks",
            "price": "10",
            "caleories": "260 - 365 Kcal",
            "image": { "fields": {"file": { "url": "https://i0.wp.com/kitchenflavours.net/wp-content/uploads/2018/01/DSC_1459.jpg?fit=666%2C444&ssl=1" } } }
        }
    },
    {
        "sys": { "id": "19" },
        "fields": {
            "title": "Mojito",
            "category": "Drinks",
            "price": "35",
            "caleories": "255 - 360 Kcal",
            "image": { "fields": {"file": { "url": "https://www.liquor.com/thmb/MJRVqf-itJGY90nwUOYGXnyG-HA=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/mojito-720x720-primary-6a57f80e200c412e9a77a1687f312ff7.jpg" } } }
        }
    },
    {
        "sys": { "id": "20" },
        "fields": {
            "title": "Coffee",
            "category": "Beverages",
            "price": "15",
            "caleories": "220 - 265 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/coffee.jpg" } } }
        }
    },
    {
        "sys": { "id": "21" },
        "fields": {
            "title": "Tea",
            "category": "Beverages",
            "price": "10",
            "caleories": "155 - 225 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/tea.jpg" } } }
        }
    },
    {
        "sys": { "id": "22" },
        "fields": {
            "title": "Chocate Frappe",
            "category": "Beverages",
            "price": "35",
            "caleories": "265 - 355 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/beverage.jpg" } } }
        }
    },
    {
        "sys": { "id": "23" },
        "fields": {
            "title": "Veg Puff",
            "category": "Bakery",
            "price": "35",
            "caleories": "260 - 320 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/puff.jpg" } } }
        }
    },
    {
        "sys": { "id": "24" },
        "fields": {
            "title": "Panner Puff",
            "category": "Bakery",
            "price": "15",
            "caleories": "255 - 390 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/samosa.jpg" } } }
        }
    },
    {
        "sys": { "id": "25" },
        "fields": {
            "title": "Khari",
            "category": "Bakery",
            "price": "20",
            "caleories": "265 - 375 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/panner-puff.jpg" } } }
        }
    },
    {
        "sys": { "id": "26" },
        "fields": {
            "title": "Noodle Puff",
            "category": "Bakery",
            "price": "15",
            "caleories": "300 - 425 Kcal",
            "image": { "fields": {"file": { "url": "assets/images/noodle-puff.jpg" } } }
        }
    }
]

// Menu Section -
const menuSection = document.querySelector('.menu-section');
// Menu Filter Buttons -
const menuFilterBtns = document.querySelectorAll('#menu-filter');

function filtering(addToCartBtn){
    // Menu Items Filteration
    menuFilterBtns.forEach( btn => {
        btn.addEventListener('click', (e)=>{
            const Category = e.currentTarget.dataset.id;

            // Current Btn Indication - 
            btn.classList.add('current')
            menuFilterBtns.forEach(i =>{
                if(i.dataset.id != Category){i.classList.remove('current')}
            })

            // Filtering Menu Items -
            addToCartBtn.forEach(item => {
                let id = item.dataset.id;
                let menuItemClass = item.parentElement.parentElement.parentElement.parentElement
                if (Category === newMenu[id-1].fields.category){
                    menuItemClass.classList.remove('display-none')
                    menuItemClass.classList.add('show')
                }
                if (Category != newMenu[id-1].fields.category){
                    menuItemClass.classList.add('display-none')
                }
                if (Category === 'all'){
                    menuItemClass.classList.remove('display-none')
                    menuItemClass.classList.add('show')
                }
            })
        })
    })
}

// Function To Create Menu Cards & Add to HTML
function displayMenuItems(menuItems){
    let displayMenu = menuItems.map(function(item){
        return `
        <article class="menu-item">
            <img src="${item.fields.image.fields.file.url}" loading="lazy" alt="Product image">
            <div class="item-info">
            <figure>
                <h2>${item.fields.title}</h2>
                <div class="item-category">${item.fields.category}</div>
                <div class="flex" style="margin-top: 10px;">
                    <i class="fas fa-fire"></i>
                    <p>${item.fields.caleories}</p>
                </div>
            </figure>
            <hr style="margin: 10px 0;">
            <div class="menu-cart-functionality">
                <div class="price">&#8377;${item.fields.price}</div>
                <div class="cart-btn-container">
                    <button class="bag-btn" id="add-to-cart-btn" data-id=${item.sys.id}>Add to Cart</i></button>
                </div>
            </div>
            </div>
        </article>
        `;
    });

    displayMenu = displayMenu.join('');
    if (menuSection) {menuSection.innerHTML = displayMenu;}
}

// ------------------ Menu.html Menu Cards END ------------------------

// ---------------- Cart Functioning ----------------
// Inside Cart Container
const cartItemsContainer = document.querySelector('.cart-items-container');
// Nav Cart Items Indicator
const cartItems = document.querySelector('.cart-items');
// Total Bill
const cartTotal = document.querySelector('.cart-total');

// Clear Cart Btn
const clearCart = document.querySelector('.clear-cart');

// Clear Cart Btn
const checkOutBtn = document.querySelector('.check-out');

// Nav Cart btn Values
const cartValues = document.querySelectorAll('#cart-values');

// Item Quantity -
var quantity = 1;

// Cart
var addItem = [];

// Add Id & quantity of Food Item - 
function foodItemCartBtn(data_id, quantity, trimedEmailID, addItem){
    // Add Food ID to object
    var product = {
        FoodID: data_id,
        Quantity: quantity
    }
    // add that to last position
    addItem.push(product);

    if (addItem.length != 0){
        // Save to Firebase DB
        firebase.database().ref('Users_Carts/' + trimedEmailID + '_Cart').set({
            Details: addItem,
            Total_Amount: 0
        });
    }
}

// Add Items in User Cart -
function showUserCart(addItem, trimedEmailID){

    let totalAmount = 0;
    let No_of_Item = 0;
  
    // Remove All Stored Previous items
    cartItemsContainer.innerHTML = ''

    addItem.forEach(item => {
        let id = item.FoodID - 1;
        // Quantity of Current Item
        let quantity = item.Quantity;
        No_of_Item += quantity;
        // Menu Fields
        let inMenu = newMenu[id].fields;
        // Total Amount Calc
        totalAmount = totalAmount + (quantity * inMenu.price);
        // Creating Cart Item in Cart
        var div = document.createElement('article');
        div.classList.add('cart-item')
        div.innerHTML = `
            <div><img src="${inMenu.image.fields.file.url}" alt="Food item image"></div>
            <div class="cart-info">
                <h3 id'c-title'>${inMenu.title}</h3>
                <p>&#8377;${inMenu.price}</p>
                <span class="remove-item" data-id=${id+1}>remove</span>
            </div>
            <div class="flex-column"> 
                <i class="fas fa-chevron-up" data-id=${id+1}></i>
                <p class="item-amount">${item.Quantity}</p>
                <i class="fas fa-chevron-down" data-id=${id+1}></i>
            </div>
        ` 
        cartItemsContainer.appendChild(div);
    })

    // Set Total Amount Value in Firebase DB & UI-
    firebase
    .database()
    .ref('Users_Carts/' + trimedEmailID + '_Cart')
    .update({Details: addItem, Total_Amount: totalAmount})
    // UI
    cartTotal.innerHTML = totalAmount;
    cartValues.forEach(values=>{values.innerHTML = No_of_Item;})

    // If user orders than send cart to orders
    userCart = { Details: addItem, Total_Amount: totalAmount }
    return userCart
}

// User Operations in Cart
function cartFunctionalities (addItem, trimedEmailID, addToCartBtn){
    // In Cart Buttons & Functionalities -
    cartItemsContainer.addEventListener('click', event => {
        // When Remove Btn is clicked
        if (event.target.classList.contains('remove-item')){
            let removeBtn = event.target;
            let id = removeBtn.dataset.id;

            // Remove Item From Array -
            addItem.forEach(item => {
                if (item.FoodID === id){ 
                    addItem.splice(addItem.indexOf(item) ,1) 
                    if ( window.location != 'http://127.0.0.1:5502/user-orders.html'){
                        // Enable removed items btn
                        addToCartBtn[item.FoodID-1].disabled = false;
                        addToCartBtn[item.FoodID-1].innerHTML = 'Add to Cart';
                    }
                    if (addItem.length === 0){
                        cartItemsContainer.innerHTML = '';
                        cartValues.forEach(values => { values.innerHTML = '0';})
                        cartTotal.innerHTML = '0';
                        
                        // Remove in Firebase DB
                        firebase
                        .database()
                        .ref('Users_Carts/' + trimedEmailID + '_Cart')
                        .remove()
                    }
                }
            })

            // If last element in cart if removed - 
            if (addItem.length === 0){ 
                cartItemsContainer.innerHTML = '';
                cartValues.forEach(values => { values.innerHTML = '0';})
            }
            
            // Remove (i.e update) In Firebase DB
            firebase
            .database()
            .ref('Users_Carts/' + trimedEmailID + '_Cart')
            .update({Details: addItem})
        }
        // When Add Quantity is clicked
        else if (event.target.classList.contains('fa-chevron-up')){
            let addAmount = event.target;
            let id = addAmount.dataset.id;

            // Update Array -
            addItem.forEach(item => {                
                if (item.FoodID === id){
                    item.Quantity += 1;
                }
            })
            // Update in Firebase DB
            firebase.database()
            .ref('Users_Carts/' + trimedEmailID + '_Cart')
            .update({ Details: addItem })
        }
        // When lower Quantity is clicked
        else if (event.target.classList.contains('fa-chevron-down')){
            let lowerAmount = event.target;
            let id = lowerAmount.dataset.id;

            // Update Array -
            addItem.forEach(item => {                
                if (item.FoodID === id && item.Quantity >= 1){
                    item.Quantity -= 1;
                    if (item.Quantity === 0){
                        if ( window.location != 'https://mit-canteen.netlify.app/user-orders.html'){
                            // Enable Buttons - so user can use them again
                            // Enable removed items btn
                            addToCartBtn[item.FoodID-1].disabled = false;
                            addToCartBtn[item.FoodID-1].innerHTML = 'Add to Cart';
                        }
                        // Update Array -
                        addItem.splice(addItem.indexOf(item) ,1);
                        if (addItem.length === 0){
                            cartItemsContainer.innerHTML = '';
                            cartValues.forEach(values => { values.innerHTML = '0';})
                            cartTotal.innerHTML = '0';
                            // Remove in Firebase DB
                            firebase
                            .database()
                            .ref('Users_Carts/' + trimedEmailID + '_Cart')
                            .remove()
                        }
                    }
                }
            })

            // Update in Firebase DB
            firebase
            .database()
            .ref('Users_Carts/' + trimedEmailID + '_Cart')
            .update({ Details: addItem })
        }
    })
}

// Remove all items in cart
function clearUserCart(addItem, addToCartBtn, trimedEmailID){
    cartItemsContainer.innerHTML = '';
    cartValues.forEach(values => { values.innerHTML = '0';})
    cartTotal.innerHTML = '0';
    if ( window.location != 'https://mit-canteen.netlify.app/user-orders.html'){
        // Enable removed items btn
        addItem.forEach(item=>{
            addToCartBtn[item.FoodID-1].disabled = false;
            addToCartBtn[item.FoodID-1].innerHTML = 'Add to Cart';
        })
    }

    // Empty Local Cart 
    addItem = []

    // Update in Firebase DB
    firebase
    .database()
    .ref('Users_Carts/' + trimedEmailID + '_Cart')
    .remove()
}

// User Order's Management -
function userOrderManagement (trimedEmailID , userCart, userEmailID){

    const orderDate = new Date().toLocaleDateString();
    var orderTime = new Date().toLocaleTimeString();
    // To check AM or PM
    var hours = new Date().getHours();
    // Check AM or PM
    if ( hours >= 12){ orderTime = orderTime + ' PM' }
    else { orderTime = orderTime + ' AM' }
    
    // Current Order
    let current_order = {
        Email_ID: userEmailID,
        Order_Status: true,
        User_Cart: userCart,
        Payment_Status: false,
        Delivery_Status: false,
        Order_Date: orderDate,
        Order_Time: orderTime,
    }

    // Add Current Order To User Orders list 
    firebase.database()
    .ref('Users_Order/' + trimedEmailID + '_Orders')
    .push(current_order);
}

// Main.js When Content Loaded
document.addEventListener('DOMContentLoaded', () =>{
    // Client UI
    displayMenuItems(newMenu);
    showUserCart(addItem)
    const addToCartBtn = document.querySelectorAll('#add-to-cart-btn');
    // Menu Filtering items
    filtering(addToCartBtn)
    ClientDataFlow(addToCartBtn)
});

// When User Loggin and Do Stuff
function ClientDataFlow(addToCartBtn){
    // When User Is logged In
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            const userEmailID = user.email
            var trimedEmailID = makeUserDataID(userEmailID);
            console.log(trimedEmailID);

            // Get Cart Items already stored
            firebase.database()
            .ref('Users_Carts/' + trimedEmailID + '_Cart')
            .on('value', function(snapshot){
                if (snapshot.exists()){
                    var userCart = snapshot.val().Details;
                    // Empty Array
                    addItem = []
                    for (let i = 0; i< userCart.length; i++){
                        // Store previouly added items to array -
                        addItem.push(userCart[i])
                        // Disable already added items
                        if (window.location != 'https://mit-canteen.netlify.app/user-orders.html'){
                            addToCartBtn[userCart[i].FoodID-1].disabled = true;
                            addToCartBtn[userCart[i].FoodID-1].innerHTML = 'In Cart';
                        }
                    }
                    cartFunctionalities(addItem, trimedEmailID, addToCartBtn);
                    showUserCart(addItem, trimedEmailID);
                }
            })
            
            // Cart Buttons -
            if (addToCartBtn){
                addToCartBtn.forEach(btn => {
                    btn.addEventListener('click', ()=> {
                        var quantity = 1;
                        const data_id = btn.dataset.id;
                        // Set Values In Firebase DB
                        foodItemCartBtn(data_id, quantity, trimedEmailID, addItem);
                    });
                });
            }

            // Remove all items from Cart -
            clearCart.addEventListener('click', ()=>{
                clearUserCart(addItem, addToCartBtn, trimedEmailID);
                addItem = []
            })

            // User Check Out's -
            checkOutBtn.addEventListener('click', ()=>{
                // Check If Cart is Empty or not -
                if (addItem.length != 0){
                    // Order
                    let userCart = showUserCart(addItem, trimedEmailID);
                    userOrderManagement(trimedEmailID, userCart, userEmailID);
                    // Empty User Cart
                    cartItemsContainer.innerHTML = '';
                    clearUserCart(addItem, addToCartBtn, trimedEmailID);
                    addItem = []
                    Swal.fire({
                        icon: 'success',
                        title: 'Order Successfully Recorded',
                    });
                    window.setTimeout(function(){
                        window.location.replace('https://mit-canteen.netlify.app/user-orders.html')
                    }, 2600)
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Empty Cart: Add Some items in Cart',
                    })
                }
            })

            // Shows Orders
            if (window.location.href === 'https://mit-canteen.netlify.app/user-orders.html'){
                setOrderDetails(trimedEmailID)
            }
        } else {
        console.log('no user logged in');
        }
    });
}
